name: whatspire-production

services:
  postgres:
    image: pgvector/pgvector:pg18-trixie
    container_name: whatspire-postgres-prod
    environment:
      POSTGRES_USER: whatspire
      POSTGRES_PASSWORD: ${DB_PASSWORD:-changeme}
      POSTGRES_DB: whatspire
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U whatspire"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - whatspire-network

  whatsapp:
    build:
      context: ./apps/server
      dockerfile: Dockerfile
    container_name: whatspire-whatsapp
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      # Database Configuration
      WHATSAPP_DATABASE_DRIVER: postgres
      WHATSAPP_DATABASE_DSN: "host=postgres user=whatspire password=${DB_PASSWORD:-changeme} dbname=whatspire port=5432 sslmode=disable"
      WHATSAPP_DATABASE_MAX_IDLE_CONNS: 10
      WHATSAPP_DATABASE_MAX_OPEN_CONNS: 100
      WHATSAPP_DATABASE_CONN_MAX_LIFETIME: 1h
      WHATSAPP_DATABASE_LOG_LEVEL: warn

      # Server Configuration
      WHATSAPP_SERVER_HOST: 0.0.0.0
      WHATSAPP_SERVER_PORT: 8080

      # WhatsApp Configuration
      WHATSAPP_DB_PATH: /data/whatsmeow.db
      WHATSAPP_QR_TIMEOUT: 2m
      WHATSAPP_RECONNECT_DELAY: 5s
      WHATSAPP_MAX_RECONNECTS: 10
      WHATSAPP_MESSAGE_RATE_LIMIT: 30

      # WebSocket Configuration
      WHATSAPP_WEBSOCKET_URL: ${WEBSOCKET_URL:-ws://api:3000/ws/whatsapp}
      WHATSAPP_WEBSOCKET_API_KEY: ${WEBSOCKET_API_KEY}
      WHATSAPP_WEBSOCKET_PING_INTERVAL: 30s
      WHATSAPP_WEBSOCKET_PONG_TIMEOUT: 10s
      WHATSAPP_WEBSOCKET_RECONNECT_DELAY: 5s
      WHATSAPP_WEBSOCKET_MAX_RECONNECTS: 0
      WHATSAPP_WEBSOCKET_QUEUE_SIZE: 1000

      # Logging Configuration
      WHATSAPP_LOG_LEVEL: info
      WHATSAPP_LOG_FORMAT: json

      # Rate Limiting
      WHATSAPP_RATELIMIT_ENABLED: true
      WHATSAPP_RATELIMIT_RPS: 10
      WHATSAPP_RATELIMIT_BURST: 20
      WHATSAPP_RATELIMIT_BY_IP: true
      WHATSAPP_RATELIMIT_BY_API_KEY: false

      # API Key Authentication
      WHATSAPP_API_KEY_ENABLED: ${API_KEY_ENABLED:-false}
      WHATSAPP_API_KEYS: ${API_KEYS}
      WHATSAPP_API_KEY_HEADER: X-API-Key

      # Metrics
      WHATSAPP_METRICS_ENABLED: true
      WHATSAPP_METRICS_PATH: /metrics
      WHATSAPP_METRICS_NAMESPACE: whatsapp

      # Circuit Breaker
      WHATSAPP_CIRCUIT_BREAKER_ENABLED: true
      WHATSAPP_CIRCUIT_BREAKER_MAX_REQUESTS: 3
      WHATSAPP_CIRCUIT_BREAKER_INTERVAL: 60s
      WHATSAPP_CIRCUIT_BREAKER_TIMEOUT: 30s
      WHATSAPP_CIRCUIT_BREAKER_FAILURE_THRESHOLD: 5
      WHATSAPP_CIRCUIT_BREAKER_SUCCESS_THRESHOLD: 2

      # Media Storage
      WHATSAPP_MEDIA_BASE_PATH: /data/media
      WHATSAPP_MEDIA_BASE_URL: ${MEDIA_BASE_URL:-http://localhost:8080/media}
      WHATSAPP_MEDIA_MAX_FILE_SIZE: 16777216

      # Webhook Configuration
      WHATSAPP_WEBHOOK_ENABLED: ${WEBHOOK_ENABLED:-false}
      WHATSAPP_WEBHOOK_URL: ${WEBHOOK_URL}
      WHATSAPP_WEBHOOK_SECRET: ${WEBHOOK_SECRET}
      WHATSAPP_WEBHOOK_EVENTS: ${WEBHOOK_EVENTS}

      # Event Storage
      WHATSAPP_EVENTS_ENABLED: ${EVENTS_ENABLED:-false}
      WHATSAPP_EVENTS_RETENTION_DAYS: 30
      WHATSAPP_EVENTS_CLEANUP_TIME: "02:00"
      WHATSAPP_EVENTS_CLEANUP_INTERVAL: 1h

    ports:
      - "8080:8080"
    volumes:
      - whatsapp_data:/data
    restart: unless-stopped
    networks:
      - whatspire-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

volumes:
  postgres_data:
    driver: local
  whatsapp_data:
    driver: local

networks:
  whatspire-network:
    driver: bridge
