name: whatspire

# Production Docker Compose Configuration
# This file is optimized for production deployments with:
# - Security hardening
# - Resource limits
# - Health checks
# - Logging configuration
# - Restart policies
# - Network isolation

name: whatspire-prod

services:
  # PostgreSQL Database
  postgres:
    image: pgvector/pgvector:pg18-trixie
    container_name: whatspire-postgres-prod
    restart: always

    environment:
      TZ: ${TZ:-UTC}
      POSTGRES_USER: ${POSTGRES_USER:-whatspire}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      POSTGRES_DB: ${POSTGRES_DB:-whatspire_prod}
      # Performance tuning
      POSTGRES_SHARED_BUFFERS: ${POSTGRES_SHARED_BUFFERS:-256MB}
      POSTGRES_EFFECTIVE_CACHE_SIZE: ${POSTGRES_EFFECTIVE_CACHE_SIZE:-1GB}
      POSTGRES_MAX_CONNECTIONS: ${POSTGRES_MAX_CONNECTIONS:-100}

    ports:
      # Bind to localhost only for security
      - "127.0.0.1:5432:5432"

    volumes:
      - postgres_data:/var/lib/postgresql
      # Optional: Custom PostgreSQL configuration
      # - ./config/postgresql.conf:/etc/postgresql/postgresql.conf:ro

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-whatspire}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 2G
        reservations:
          cpus: "0.5"
          memory: 512M

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"
        compress: "true"

    networks:
      - whatspire-backend

    # Security options
    security_opt:
      - no-new-privileges:true

    # Read-only root filesystem (except for data volume)
    read_only: true
    tmpfs:
      - /tmp
      - /var/run/postgresql

  # WhatsApp Service
  whatsapp-service:
    build:
      context: ./apps/server
      dockerfile: Dockerfile
      args:
        - BUILDKIT_INLINE_CACHE=1
    image: whatsapp-service:${VERSION:-latest}
    container_name: whatspire-whatsapp-prod
    restart: always

    # Bind to localhost only - use reverse proxy for external access
    ports:
      - "127.0.0.1:8080:8080"

    environment:
      # Application settings
      GIN_MODE: release
      TZ: ${TZ:-UTC}

      # Database connection (if using PostgreSQL)
      # DB_DRIVER: postgres
      # DB_DSN: postgresql://${POSTGRES_USER:-whatspire}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-whatspire_prod}?sslmode=disable

      # Optional: Override config via environment variables
      # SERVER_HOST: 0.0.0.0
      # SERVER_PORT: 8080
      # LOG_LEVEL: info
      # LOG_FORMAT: json

    volumes:
      # Persistent data
      - whatsapp_data:/data
      # Configuration (read-only)
      - ./apps/server/config.yaml:/app/config.yaml:ro
      # Optional: Custom CA certificates
      # - /etc/ssl/certs:/etc/ssl/certs:ro

    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:8080/health",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 1G
        reservations:
          cpus: "0.5"
          memory: 256M

      # Restart policy
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"
        compress: "true"

    networks:
      - whatspire-backend
      - whatspire-frontend

    # Security options
    security_opt:
      - no-new-privileges:true

    # Depends on PostgreSQL being healthy
    depends_on:
      postgres:
        condition: service_healthy

    # User namespace remapping (already runs as non-root in Dockerfile)
    user: "1000:1000"

  # Optional: Nginx Reverse Proxy
  # Uncomment to enable reverse proxy with SSL termination
  # nginx:
  #   image: nginx:alpine
  #   container_name: whatspire-nginx-prod
  #   restart: always
  #
  #   ports:
  #     - "80:80"
  #     - "443:443"
  #
  #   volumes:
  #     - ./config/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
  #     - ./config/nginx/conf.d:/etc/nginx/conf.d:ro
  #     - ./config/ssl:/etc/nginx/ssl:ro
  #     - nginx_cache:/var/cache/nginx
  #     - nginx_logs:/var/log/nginx
  #
  #   healthcheck:
  #     test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/health"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3
  #
  #   deploy:
  #     resources:
  #       limits:
  #         cpus: '1'
  #         memory: 512M
  #       reservations:
  #         cpus: '0.25'
  #         memory: 128M
  #
  #   logging:
  #     driver: "json-file"
  #     options:
  #       max-size: "10m"
  #       max-file: "5"
  #       compress: "true"
  #
  #   networks:
  #     - whatspire-frontend
  #
  #   security_opt:
  #     - no-new-privileges:true
  #
  #   depends_on:
  #     - whatsapp-service

  # Optional: Prometheus for monitoring
  # prometheus:
  #   image: prom/prometheus:latest
  #   container_name: whatspire-prometheus-prod
  #   restart: always
  #
  #   ports:
  #     - "127.0.0.1:9090:9090"
  #
  #   volumes:
  #     - ./config/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
  #     - prometheus_data:/prometheus
  #
  #   command:
  #     - '--config.file=/etc/prometheus/prometheus.yml'
  #     - '--storage.tsdb.path=/prometheus'
  #     - '--storage.tsdb.retention.time=30d'
  #
  #   networks:
  #     - whatspire-backend
  #
  #   security_opt:
  #     - no-new-privileges:true

  # Optional: Grafana for visualization
  # grafana:
  #   image: grafana/grafana:latest
  #   container_name: whatspire-grafana-prod
  #   restart: always
  #
  #   ports:
  #     - "127.0.0.1:3000:3000"
  #
  #   environment:
  #     GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD:?GRAFANA_ADMIN_PASSWORD is required}
  #     GF_INSTALL_PLUGINS: ""
  #
  #   volumes:
  #     - grafana_data:/var/lib/grafana
  #     - ./config/grafana/provisioning:/etc/grafana/provisioning:ro
  #
  #   networks:
  #     - whatspire-backend
  #
  #   security_opt:
  #     - no-new-privileges:true
  #
  #   depends_on:
  #     - prometheus

# Named volumes for data persistence
volumes:
  postgres_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_PATH:-./data}/postgres

  whatsapp_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_PATH:-./data}/whatsapp

  # nginx_cache:
  #   driver: local
  #
  # nginx_logs:
  #   driver: local
  #
  # prometheus_data:
  #   driver: local
  #
  # grafana_data:
  #   driver: local

# Network configuration
networks:
  # Backend network (database and application)
  whatspire-backend:
    driver: bridge
    internal: true # No external access
    ipam:
      config:
        - subnet: 172.20.0.0/24

  # Frontend network (application and reverse proxy)
  whatspire-frontend:
    driver: bridge
    ipam:
      config:
        - subnet: 172.21.0.0/24
